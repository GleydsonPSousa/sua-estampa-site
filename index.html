<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sua Estampa ERP</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-slate-100 font-sans">

<!-- LOGIN -->
<div id="login-screen" class="min-h-screen flex items-center justify-center">
  <div class="bg-white p-8 rounded-2xl shadow-xl w-96">
    <h2 class="text-2xl font-bold mb-6 text-center">Sua Estampa ERP</h2>
    <form id="login-form" class="space-y-4">
      <input id="username" class="w-full p-3 border rounded-lg" placeholder="Usuário" required>
      <input id="password" type="password" class="w-full p-3 border rounded-lg" placeholder="Senha" required>
      <button class="w-full bg-indigo-600 text-white p-3 rounded-lg font-bold">Entrar</button>
      <p id="login-error" class="text-red-500 text-sm hidden">Login inválido</p>
    </form>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="hidden p-6 max-w-7xl mx-auto">

  <div class="flex justify-between mb-6">
    <h1 class="text-2xl font-bold">Painel ERP</h1>
    <button onclick="logout()" class="text-red-500 font-bold">Sair</button>
  </div>

  <div class="grid grid-cols-4 gap-4 mb-6">
    <div class="bg-white p-4 rounded-xl shadow">
      <p>Saldo</p>
      <h2 id="saldo" class="text-xl font-bold">R$ 0</h2>
    </div>
    <div class="bg-white p-4 rounded-xl shadow">
      <p>Entradas</p>
      <h2 id="entradas" class="text-xl font-bold">R$ 0</h2>
    </div>
    <div class="bg-white p-4 rounded-xl shadow">
      <p>Saídas</p>
      <h2 id="saidas" class="text-xl font-bold">R$ 0</h2>
    </div>
    <div class="bg-white p-4 rounded-xl shadow">
      <p>Margem</p>
      <h2 id="margem" class="text-xl font-bold">0%</h2>
    </div>
  </div>

  <!-- NOVA DESPESA -->
  <div class="bg-white p-6 rounded-xl shadow mb-6">
    <h2 class="font-bold mb-4">Registrar Despesa</h2>
    <form id="finance-form" class="grid grid-cols-4 gap-4">
      <input id="fin-desc" placeholder="Descrição" required class="p-2 border rounded">
      <input id="fin-value" type="number" step="0.01" placeholder="Valor" required class="p-2 border rounded">
      <input id="fin-date" type="date" required class="p-2 border rounded">
      <button class="bg-red-500 text-white rounded">Salvar</button>
    </form>
  </div>

  <!-- NOVO PEDIDO -->
  <div class="bg-white p-6 rounded-xl shadow mb-6">
    <h2 class="font-bold mb-4">Novo Pedido</h2>
    <form id="order-form" class="grid grid-cols-5 gap-4">
      <input id="ord-client" placeholder="Cliente" required class="p-2 border rounded">
      <input id="ord-total" type="number" step="0.01" placeholder="Total" required class="p-2 border rounded">
      <input id="ord-entry" type="number" step="0.01" placeholder="Entrada" required class="p-2 border rounded">
      <input id="ord-date" type="date" required class="p-2 border rounded">
      <button class="bg-indigo-600 text-white rounded">Cadastrar</button>
    </form>
  </div>

  <div class="bg-white p-6 rounded-xl shadow">
    <h2 class="font-bold mb-4">Financeiro</h2>
    <table class="w-full text-left">
      <tbody id="finance-table"></tbody>
    </table>
  </div>

</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbz-k7gapi05UnDyYTY1nmhHB0S20ekk0mFe4i7MlgyRYOzxhd0g67UNfMJAabrpbNc3/exec";

async function apiGet(params){
  const query = new URLSearchParams(params).toString();
  const res = await fetch(`${API}?${query}`);
  return await res.json();
}

async function apiPost(body){
  const res = await fetch(API,{
    method:"POST",
    body: JSON.stringify(body)
  });
  return await res.json();
}

/* LOGIN */
document.getElementById("login-form").addEventListener("submit", async e=>{
  e.preventDefault();
  const user = username.value;
  const pass = password.value;

  const res = await apiGet({
    action:"login",
    username:user,
    password:pass
  });

  if(res.success){
    sessionStorage.setItem("auth","true");
    document.getElementById("login-screen").classList.add("hidden");
    document.getElementById("dashboard").classList.remove("hidden");
    loadFinance();
  } else {
    document.getElementById("login-error").classList.remove("hidden");
  }
});

function logout(){
  sessionStorage.clear();
  location.reload();
}

/* FINANCEIRO */
document.getElementById("finance-form").addEventListener("submit", async e=>{
  e.preventDefault();

  await apiPost({
    action:"addFinance",
    payload:[
      Date.now(),
      "expense",
      document.getElementById("fin-desc").value,
      "Manual",
      parseFloat(document.getElementById("fin-value").value),
      document.getElementById("fin-date").value
    ]
  });

  loadFinance();
});

async function loadFinance(){
  const data = await apiGet({action:"getFinance"});
  renderFinance(data);
}

function renderFinance(data){
  let entradas=0, saidas=0;
  finance-table.innerHTML="";
  
  data.slice(1).forEach(row=>{
    const tipo=row[1];
    const valor=parseFloat(row[4]);

    if(tipo==="income") entradas+=valor;
    if(tipo==="expense") saidas+=valor;

    finance-table.innerHTML+=`
      <tr class="border-b">
        <td>${row[2]}</td>
        <td>${tipo}</td>
        <td>R$ ${valor.toFixed(2)}</td>
      </tr>`;
  });

  saldo.innerText="R$ "+(entradas-saidas).toFixed(2);
  entradas.innerText="R$ "+entradas.toFixed(2);
  saidas.innerText="R$ "+saidas.toFixed(2);
  margem.innerText=entradas>0?((entradas-saidas)/entradas*100).toFixed(1)+"%":"0%";
}

/* PEDIDO */
document.getElementById("order-form").addEventListener("submit", async e=>{
  e.preventDefault();

  const total=parseFloat(ord-total.value);
  const entrada=parseFloat(ord-entry.value);

  await apiPost({
    action:"addOrder",
    payload:[
      Date.now(),
      ord-client.value,
      "",
      "",
      total,
      entrada,
      total-entrada,
      ord-date.value,
      "",
      "pendente"
    ]
  });

  await apiPost({
    action:"addFinance",
    payload:[
      Date.now(),
      "income",
      "Entrada "+ord-client.value,
      "Venda",
      entrada,
      ord-date.value
    ]
  });

  loadFinance();
});
</script>
</body>
</html>