<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sua Estampa Confecção - ERP Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .card { background: white; border-radius: 1rem; border: 1px solid #e2e8f0; }
        .btn-primary { background: #0f172a; color: white; transition: all 0.2s; }
        .hidden-section { display: none !important; }
        .nav-link-active { background-color: #f0f4ff; color: #4f46e5; border-bottom: 2px solid #4f46e5; }
        #loading-overlay { display: none; }
        #loading-overlay.active { display: flex; }
    </style>
</head>
<body class="antialiased text-slate-900">

    <div id="loading-overlay" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[100] items-center justify-center flex-col text-white">
        <div class="w-12 h-12 border-4 border-indigo-400 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p id="loading-text" class="font-bold tracking-widest uppercase text-xs text-center">Sincronizando...</p>
    </div>

    <!-- Tela de Login -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4 bg-slate-50">
        <div class="max-w-md w-full">
            <div class="text-center mb-8">
                <div class="inline-flex w-14 h-14 bg-indigo-600 rounded-2xl items-center justify-center text-white font-bold text-3xl mb-4 shadow-xl">S</div>
                <h1 class="text-2xl font-bold text-slate-800 tracking-tight">Sua Estampa Cloud</h1>
                <p class="text-slate-500 text-sm">Validando acesso via Planilha Google</p>
            </div>
            <div class="card p-8 shadow-2xl">
                <form id="login-form" class="space-y-5">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1.5 tracking-wider">Usuário (na Planilha)</label>
                        <input type="text" id="username" required class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-indigo-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1.5 tracking-wider">Senha</label>
                        <input type="password" id="password" required class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-indigo-500 outline-none">
                    </div>
                    <div id="login-error" class="hidden text-rose-500 text-xs font-bold bg-rose-50 p-3 rounded-lg border border-rose-100 text-center italic">Usuário ou Senha incorretos na nuvem.</div>
                    <button type="submit" class="w-full btn-primary font-bold py-3.5 rounded-xl">Entrar no Sistema</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Interface Principal -->
    <div id="main-dashboard" class="hidden-section">
        <nav class="bg-white border-b border-slate-200 px-6 py-2 sticky top-0 z-40">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center gap-8">
                    <span class="text-lg font-bold text-slate-800">Sua Estampa</span>
                    <div class="flex gap-1 h-full">
                        <button onclick="switchTab('finance')" id="tab-btn-finance" class="px-5 py-4 text-sm font-bold nav-link-active">Financeiro</button>
                        <button onclick="switchTab('orders')" id="tab-btn-orders" class="px-5 py-4 text-sm font-bold text-slate-500">Produção</button>
                    </div>
                </div>
                <button onclick="logout()" class="text-xs font-bold text-rose-500 px-3 py-2">Sair</button>
            </div>
        </nav>

        <main id="section-finance" class="max-w-7xl mx-auto px-6 py-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="card p-6 border-b-4 border-b-emerald-400">
                    <p class="text-[10px] font-black uppercase text-slate-400 mb-1">Entradas</p>
                    <h3 id="stat-income" class="text-2xl font-bold">R$ 0,00</h3>
                </div>
                <div class="card p-6 border-b-4 border-b-rose-400">
                    <p class="text-[10px] font-black uppercase text-slate-400 mb-1">Saídas</p>
                    <h3 id="stat-expense" class="text-2xl font-bold">R$ 0,00</h3>
                </div>
                <div class="card p-6 border-b-4 border-b-indigo-400">
                    <p class="text-[10px] font-black uppercase text-slate-400 mb-1">Saldo Atual</p>
                    <h3 id="stat-balance" class="text-2xl font-bold">R$ 0,00</h3>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-4">
                    <div class="card p-6">
                        <h2 class="font-bold mb-4">Lançar Despesa</h2>
                        <form id="finance-form" class="space-y-4">
                            <input type="text" id="fin-desc" required placeholder="Descrição" class="w-full px-4 py-3 border rounded-xl outline-none">
                            <input type="number" step="0.01" id="fin-amount" required placeholder="Valor R$" class="w-full px-4 py-3 border rounded-xl outline-none">
                            <input type="date" id="fin-date" required class="w-full px-4 py-3 border rounded-xl">
                            <button type="submit" class="w-full bg-rose-500 text-white font-bold py-3 rounded-xl uppercase text-xs tracking-widest">Registrar Saída</button>
                        </form>
                    </div>
                </div>
                <div class="lg:col-span-8">
                    <div class="card overflow-hidden">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="p-4">Descrição</th>
                                    <th class="p-4 text-right">Valor</th>
                                </tr>
                            </thead>
                            <tbody id="fin-table" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>

        <main id="section-orders" class="max-w-7xl mx-auto px-6 py-8 hidden-section">
            <div id="order-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </main>
    </div>

    <script>
        /**
         * CONFIGURAÇÃO: Insira a URL do seu AppScript aqui
         */
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyu7kUKSVTcBIxR_acxD8IKMSpG3HwmEFwIpWB-Et0sb961FSLEgW5S-rpuwmi21QUg/exec"; 

        let financeData = [];
        let ordersData = [];

        // --- AUTH CLOUD ---
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;

            if(!SCRIPT_URL) {
                alert("ERRO: SCRIPT_URL não definida no código.");
                return;
            }

            setLoading(true, "Autenticando na Nuvem...");
            try {
                const response = await fetch(`${SCRIPT_URL}?action=login&user=${user}&pass=${pass}`);
                const result = await response.json();

                if(result.success) {
                    sessionStorage.setItem('sua_estampa_auth', 'true');
                    initApp();
                } else {
                    document.getElementById('login-error').classList.remove('hidden');
                }
            } catch (err) {
                console.error(err);
                alert("Erro ao conectar com o servidor do Google.");
            } finally {
                setLoading(false);
            }
        });

        async function initApp() {
            document.getElementById('login-screen').classList.add('hidden-section');
            document.getElementById('main-dashboard').classList.remove('hidden-section');
            await fetchData();
        }

        async function fetchData() {
            setLoading(true, "Lendo Planilha...");
            try {
                const response = await fetch(SCRIPT_URL);
                const data = await response.json();
                financeData = data.finance || [];
                ordersData = data.orders || [];
                renderAll();
            } catch (err) {
                console.error(err);
            } finally {
                setLoading(false);
            }
        }

        function renderAll() {
            const table = document.getElementById('fin-table');
            table.innerHTML = '';
            let inc = 0, exp = 0;

            financeData.forEach(item => {
                const val = parseFloat(item.amount);
                if(item.type === 'income') inc += val; else exp += val;
                table.innerHTML += `
                    <tr>
                        <td class="p-4"><div class="font-bold">${item.desc}</div><div class="text-[10px] text-slate-400">${item.date}</div></td>
                        <td class="p-4 text-right font-bold ${item.type === 'income' ? 'text-emerald-600' : 'text-rose-500'}">R$ ${val.toFixed(2)}</td>
                    </tr>
                `;
            });

            document.getElementById('stat-income').innerText = `R$ ${inc.toFixed(2)}`;
            document.getElementById('stat-expense').innerText = `R$ ${exp.toFixed(2)}`;
            document.getElementById('stat-balance').innerText = `R$ ${(inc - exp).toFixed(2)}`;

            const grid = document.getElementById('order-grid');
            grid.innerHTML = '';
            ordersData.filter(o => o.status !== 'concluido').forEach(o => {
                grid.innerHTML += `
                    <div class="card p-6 border-l-4 ${o.status === 'pendente' ? 'border-amber-400' : 'border-indigo-500'}">
                        <h4 class="font-bold uppercase mb-2">${o.client}</h4>
                        <p class="text-xs text-slate-500 mb-4">${o.items}</p>
                        <div class="flex justify-between text-[10px] font-bold">
                            <span>Falta: R$ ${parseFloat(o.balance).toFixed(2)}</span>
                            <span>Prazo: ${o.deadline}</span>
                        </div>
                    </div>
                `;
            });
        }

        function setLoading(show, text = "") {
            const overlay = document.getElementById('loading-overlay');
            if(text) document.getElementById('loading-text').innerText = text;
            overlay.classList.toggle('active', show);
        }

        function switchTab(tab) {
            document.getElementById('section-finance').classList.toggle('hidden-section', tab !== 'finance');
            document.getElementById('section-orders').classList.toggle('hidden-section', tab !== 'orders');
            document.getElementById('tab-btn-finance').classList.toggle('nav-link-active', tab === 'finance');
            document.getElementById('tab-btn-orders').classList.toggle('nav-link-active', tab === 'orders');
        }

        function logout() { sessionStorage.clear(); location.reload(); }
        if(sessionStorage.getItem('sua_estampa_auth')) initApp();
    </script>
</body>
</html>

